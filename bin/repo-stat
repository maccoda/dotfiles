#!/bin/bash
startDir=${1:-.}
echo "Starting at $startDir"

echo -n "Fetching updates for "
dirs=$(fd -HI -t d .git$ $startDir)
 for dir in $dirs; do
    repoDir=$(echo $dir | sed 's/\/.git//')
    short_name=$(basename $repoDir)
    echo -n "$short_name "
    cd $repoDir
    git fetch &
    cd - > /dev/null
done

echo
wait

for dir in $dirs; do
    repoDir=$(echo $dir | sed 's/\/.git//')
    cd $repoDir
    short_name=$(basename $repoDir)

    status=$(git status --porcelain &)
    commits=$(git log origin/mainline..mainline 2> /dev/null | grep '^commit' | wc -l | tr -d " " &)
    commits_behind=$(git log mainline..origin/mainline 2> /dev/null | grep '^commit' | wc -l | tr -d " " &)

    wait

    if [[ ! -z "$status" ]]; then
        echo "$short_name is dirty"
    fi
    if [[ $commits -gt "0" ]]; then
        echo "$short_name is ahead of origin"
    fi
    if [[ $commits_behind -gt "0" ]]; then
        echo "$short_name is behind origin"
        read -p "Would you like to pull updates? (y/n) " input
        case $input in
            [Yy]* ) git pull;;
            * ) echo "Leaving $short_name behind origin";;
        esac
    fi
    cd - > /dev/null
done

